#!/usr/bin/env python
import shlex
import re
import subprocess as sp
from pathlib import Path


def run_cmd(cmd: list[str]):
    res = sp.run(
        cmd,
        capture_output=True,
        check=True,
        timeout=7,
    )
    return res.stdout


def quote(line):
    k, v = line.strip().split("=", 1)
    return "{}={}".format(k, shlex.quote(v))


cmds = [
    shlex.split(cmd)
    for cmd in Path(".env-inject").read_text().splitlines()
    if not re.match(r"\s*(#|$)", cmd)
]

stmts_unquoted = []
for cmd in cmds:
    stdout = run_cmd(cmd)
    stmts_unquoted.extend(stdout.decode("utf-8").splitlines())

stmts = [quote(x) for x in stmts_unquoted if not re.match(r"\s*(#|$)", x)]
print("\n".join(stmts))
